<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Rewriter - V5</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600;700&family=Bai+Jamjuree:wght@400;600&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-start: #ee0979; 
            --bg-end: #ff6a00; 
            --accent-primary: #7F5FFF; 
            --accent-secondary: #00BFFF; 
            --text-color: #000000; 
            --card-color: #FFFFFF; 
            --glass-color: rgba(255, 255, 255, 0.9); 
            --track-color: rgba(0, 0, 0, 0.1); 
            --highlight-preserved: #E54099; 
            --highlight-footage: #00BFFF; 
        }

        /* Base Styles */
        body {
            font-family: 'Anuphan', sans-serif;
            transition: background-color 0.5s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Changed for footer positioning */
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
            color: var(--text-color);
            font-display: swap; 
        }

        /* Font Classes */
        .font-anuphan { font-family: 'Anuphan', sans-serif; }
        .font-bai-jamjuree { font-family: 'Bai Jamjuree', sans-serif; }
        .font-sarabun { font-family: 'Sarabun', sans-serif; }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex; justify-content: center; align-items: center;
        }

        /* Glass Card */
        .glass-card {
            background-color: var(--card-color);
            border-radius: 20px;
            padding: 2rem;
            max-width: 1200px;
            width: 100%;
            margin: auto;
            color: var(--text-color);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--accent-primary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: var(--track-color); border-radius: 4px; }

        /* Form Elements */
        input:not([type="range"]):not([type="checkbox"]), textarea, select {
            background-color: var(--glass-color); 
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border-radius: 10px;
            transition: all 0.2s;
        }
        input:not([type="range"]):not([type="checkbox"]):focus, textarea:focus, select:focus {
            background-color: var(--card-color);
            outline: none;
            box-shadow: 0 0 0 3px var(--accent-secondary);
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(90deg, #7F5FFF, #00BFFF);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(127, 95, 255, 0.5);
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0, 191, 255, 0.6); }
        
        .btn-secondary {
            background-color: #F0F0F0; color: var(--text-color);
            border: 1px solid rgba(0, 0, 0, 0.1); padding: 0.75rem 1rem;
            border-radius: 10px; transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover { background-color: #E0E0E0; }

        .toggle-btn {
            padding: 0.5rem 1rem; border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.1); transition: all 0.2s;
            background-color: #F8F8F8; color: rgba(0, 0, 0, 0.7);
        }
        .toggle-btn.active {
            border-color: var(--accent-primary);
            background: linear-gradient(90deg, #7F5FFF, #00BFFF);
            color: white; box-shadow: 0 0 8px rgba(127, 95, 255, 0.6);
        }

        /* Animations */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Textareas */
        .result-textarea-box {
            background-color: #FAFAFA; border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px; padding: 1.25rem;
            min-height: 200px; max-height: 450px; width: 100%;
            resize: vertical; white-space: pre-wrap; line-height: 1.6;
            color: var(--text-color);
            position: relative;
        }
        
        .highlight-preserved { color: var(--highlight-preserved); font-weight: 700; }
        .highlight-footage { color: var(--highlight-footage); font-weight: 600; }

        /* Range Slider */
        input[type="range"] {
            -webkit-appearance: none; width: 100%; height: 8px;
            background: var(--track-color); border-radius: 5px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            border-radius: 50%; background: var(--accent-primary); cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Theme Modal Specifics */
        #theme-modal .glass-card { background-color: var(--card-color); border: none; }

        /* Like/Dislike Buttons */
        .feedback-btn {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .like-btn {
            background-color: #F0F9FF;
            color: #059669;
            border-color: #059669;
        }
        .like-btn:hover, .like-btn.active {
            background-color: #059669;
            color: white;
        }
        .dislike-btn {
            background-color: #FEF2F2;
            color: #DC2626;
            border-color: #DC2626;
            top: 50px;
        }
        .dislike-btn:hover, .dislike-btn.active {
            background-color: #DC2626;
            color: white;
        }

        /* Theme Selection */
        .theme-option {
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .theme-option.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(127, 95, 255, 0.3);
        }

        /* Customize Button */
        .customize-btn {
            background: linear-gradient(90deg, #FF8C00, #FFA500);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.5);
        }
        .customize-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(255, 165, 0, 0.6); }

        /* Terms Button */
        .terms-btn {
            background: linear-gradient(90deg, #9C27B0, #673AB7);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.5);
        }
        .terms-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(103, 58, 183, 0.6); }

        /* Translate Button */
        .translate-btn {
            background: linear-gradient(90deg, #9C27B0, #673AB7); /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á */
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.5);
        }
        .translate-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(103, 58, 183, 0.6); }

        /* Save & Rewrite Button */
        .save-rewrite-btn {
            background: linear-gradient(90deg, #DC2626, #EF4444);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);
        }
        .save-rewrite-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6); }

        /* Home Button */
        .home-btn {
            background: linear-gradient(90deg, #FF9800, #FF5722);
            color: white; font-weight: 600; padding: 0.75rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.5);
        }
        .home-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(255, 87, 34, 0.6); }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        /* Paraphrase Button */
        .paraphrase-btn {
            background: linear-gradient(90deg, #2196F3, #03A9F4);
            color: white; font-weight: 600; padding: 0.5rem 1rem;
            border-radius: 8px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
            font-size: 0.875rem;
        }
        .paraphrase-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 15px rgba(3, 169, 244, 0.5); }

        /* Backup/Restore Buttons */
        .backup-btn {
            background: linear-gradient(90deg, #9C27B0, #673AB7);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.5);
        }
        .backup-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(103, 58, 183, 0.6); }

        .restore-btn {
            background: linear-gradient(90deg, #FF9800, #FF5722);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.5);
        }
        .restore-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(255, 87, 34, 0.6); }

        /* Selection Popup Styles */
        .selection-popup {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 250px;
        }
        .selection-popup button {
            background: linear-gradient(90deg, #7F5FFF, #00BFFF);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        .selection-popup button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .selection-popup textarea {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.75rem;
            resize: vertical;
            min-height: 60px;
        }

        /* Theme Circle Styles */
        .theme-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .theme-circle.selected {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(127, 95, 255, 0.3);
        }

        /* Character Count Styles */
        .char-count {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .char-excess {
            color: #DC2626;
            font-weight: bold;
        }

        /* Text with red color for excess characters */
        .excess-chars {
            color: #DC2626;
        }

        /* Hashtag Button */
        .hashtag-btn {
            background: linear-gradient(90deg, #9C27B0, #673AB7);
            color: white; font-weight: 600; padding: 0.75rem 1.5rem;
            border-radius: 12px; transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.5);
        }
        .hashtag-btn:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(103, 58, 183, 0.6); }

        /* Emoji Button Styles */
        .emoji-btn {
            background: #F0F0F0;
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-btn:hover {
            background: #E0E0E0;
            transform: scale(1.1);
        }
    </style>
</head>
<body class="font-anuphan" id="appBody">

    <!-- Header & Language Toggle -->
    <div class="w-full max-w-[1200px] flex justify-between items-center mb-2">
        <h1 class="text-2xl font-bold text-white">AI Rewriter V5</h1>
        <div class="flex space-x-2">
            <button onclick="toggleLanguage()" class="glass-card py-2 px-4 rounded-full flex items-center space-x-2 cursor-pointer hover:bg-white/80 text-sm font-bold text-black w-auto" style="padding: 0.5rem 1rem;">
                <i data-lucide="globe" class="w-4 h-4"></i>
                <span id="langDisplay">TH</span>
            </button>
        </div>
    </div>

    <div id="app-container" class="glass-card mb-8 relative">
        <!-- Content rendered here -->
        <div id="initial-loading" class="text-center p-8">
            <div class="spinner mx-auto mb-4"></div>
            Loading Application...
        </div>
    </div>
    
    <!-- User ID Footer -->
    <div class="text-center text-white/80 text-sm font-mono mt-auto mb-4" id="footer-info">
        <!-- User ID will be injected here -->
    </div>

    <!-- Modals -->
    <div id="theme-modal" class="modal-overlay hidden"></div>
    <div id="message-modal" class="modal-overlay hidden"></div>
    <div id="customize-modal" class="modal-overlay hidden"></div>
    <div id="terms-modal" class="modal-overlay hidden"></div>

    <script type="module">
        // --- Localization Dictionary ---
        const translations = {
            th: {
                welcomeTitle: 'üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà AI Rewriter V5',
                enterApiKey: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Gemini API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                apiKeyPlaceholder: 'API Key',
                nicknamePlaceholder: '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                saveKeyBtn: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Key ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
                resetKeyLink: '‡∏•‡πâ‡∏≤‡∏á API Key ‡πÄ‡∏î‡∏¥‡∏°',
                homeTitle: 'üöÄ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£ Rewrite',
                captionMode: '‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•',
                captionDesc: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥ & 5 ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡∏µ‡πâ',
                voiceoverMode: '‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Voiceover',
                voiceoverDesc: '‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤',
                translationMode: '‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤',
                translationDesc: '‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢-‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
                hashtagMode: '‡∏´‡∏≤ # ‡πÉ‡∏´‡πâ‡∏õ‡∏±‡∏á',
                hashtagDesc: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤',
                inputCaptionTitle: '‚úçÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏õ‡∏±‡∏á!',
                inputVoiceoverTitle: 'üéôÔ∏è ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Voiceover',
                inputTranslationTitle: 'üåê ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤',
                inputHashtagTitle: 'üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ # ‡∏™‡∏∏‡∏î‡∏õ‡∏±‡∏á',
                resultTitle: '‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£ Rewrite',
                translatedResultTitle: '‚úÖ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•',
                hashtagResultTitle: '‚úÖ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ #',
                pasteContent: '‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà:',
                placeholderContent: '‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ AI Rewrite ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö [ ] ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ)',
                placeholderTranslation: '‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤',
                placeholderHashtag: '‡∏ß‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å',
                voiceoverOptions: 'üéôÔ∏è ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Voiceover:',
                genderLabel: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:',
                female: 'üíÅ‚Äç‚ôÄÔ∏è ‡∏´‡∏ç‡∏¥‡∏á',
                male: 'ü§µ‚Äç‚ôÇÔ∏è ‡∏ä‡∏≤‡∏¢',
                katoey: 'üè≥Ô∏è‚Äç‚ößÔ∏è ‡∏à‡∏∞‡πÄ‡∏ó‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏£‡∏¥‡∏ï)',
                lengthTarget: '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß:',
                captionOptions: 'üì∏ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô:',
                maxCharsLabel: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:',
                toneLabel: '‚ú® ‡πÇ‡∏ó‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:',
                toneFun: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏∏‡∏Å',
                tonePolite: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û',
                startRewrite: '‡πÄ‡∏£‡∏¥‡πà‡∏° Rewrite',
                startTranslation: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤',
                findHashtags: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ # ‡∏™‡∏∏‡∏î‡∏õ‡∏±‡∏á',
                loading: 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏¢‡∏°‡∏ô‡∏ï‡πå...',
                originalContent: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (Before)',
                rewrittenContent: '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£ Rewrite (After)',
                translatedContent: '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• (After)',
                hashtagContent: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ #',
                copyOriginal: 'Copy ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö',
                copyScript: 'Copy ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå',
                copyTranslation: 'Copy ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•',
                copyHashtagsOnly: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ #',
                copyContentWithHashtags: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° #',
                rewriteAgain: 'Rewrite ‡πÉ‡∏´‡∏°‡πà',
                backHome: '‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å',
                findNewHashtags: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                adjustOptions: 'üõ†Ô∏è ‡∏õ‡∏£‡∏±‡∏ö Options',
                saveAndRewrite: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & Rewrite',
                themeTitle: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Theme ‡πÅ‡∏•‡∏∞ Font üåà',
                selectTheme: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Theme ‡∏™‡∏µ:',
                selectFont: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Font:',
                customTheme: '‡∏™‡∏£‡πâ‡∏≤‡∏á Theme ‡πÄ‡∏≠‡∏á (2 ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏µ):',
                saveClose: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î üíæ',
                resetKey: 'Reset Key',
                popupRewrite: '‚ú® Rewrite ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ',
                alertTitle: '‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
                alertSuccess: '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                alertError: '‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                noContent: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞',
                copySuccess: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                excessChars: '(‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤',
                chars: '‡∏ï‡∏±‡∏ß!)',
                totalTime: '‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°:',
                totalChars: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£:',
                likeBtn: '‡∏ä‡∏≠‡∏ö üëç',
                dislikeBtn: '‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö üëé',
                feedbackThanks: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏¥‡∏ä‡∏°!',
                customizeBtn: '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏â‡∏±‡∏ô',
                customizeTitle: '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß',
                customizeDesc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ô‡∏≥‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Rewrite',
                customizePlaceholder: '‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ AI ‡∏à‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à, ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô, ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡πÉ‡∏ä‡πâ ‡∏Ø‡∏•‡∏Ø',
                saveCustomData: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                translateBtn: '‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ TH-EN',
                translateLoading: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤...',
                generateSelection: 'Generate ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ',
                termsBtn: '‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
                termsTitle: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
                termsDesc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• TH-EN ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "TH = EN" ‡∏´‡∏£‡∏∑‡∏≠ "EN = TH" (‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)',
                termsPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô\n‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û = Visual Thinking\nVisual Thinking = ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û',
                saveTerms: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
                paraphraseBtn: 'Paraphrase',
                charsCount: '‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£',
                backupBtn: 'Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                restoreBtn: 'Restore ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                backupSuccess: '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                restoreSuccess: '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                backupError: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                restoreError: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                additionalPrompt: 'Prompt ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°',
                additionalPromptPlaceholder: 'Prompt ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°',
                changeNickname: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:',
                addEmojiLabel: '‡πÄ‡∏û‡∏¥‡πà‡∏° Emoji ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤:'
            },
            en: {
                welcomeTitle: 'üëã Welcome to AI Rewriter V5',
                enterApiKey: 'Please enter your Gemini API Key to start',
                apiKeyPlaceholder: 'API Key',
                nicknamePlaceholder: 'Your Nickname',
                saveKeyBtn: 'Save Key & Start',
                resetKeyLink: 'Clear API Key',
                homeTitle: 'üöÄ Select Rewrite Mode',
                captionMode: 'Social Caption',
                captionDesc: 'With Emojis & 5 Trendy Hashtags',
                voiceoverMode: 'Voiceover Script',
                voiceoverDesc: 'Concise, Engaging, Timed Scripts',
                translationMode: 'Translation',
                translationDesc: 'Translate TH-EN using special terms',
                hashtagMode: 'Find Viral #',
                hashtagDesc: 'Find relevant hashtags for your content',
                inputCaptionTitle: '‚úçÔ∏è Write Viral Caption',
                inputVoiceoverTitle: 'üéôÔ∏è Write Voiceover Script',
                inputTranslationTitle: 'üåê Translate Text',
                inputHashtagTitle: 'üîç Find Viral Hashtags',
                resultTitle: '‚úÖ Rewrite Results',
                translatedResultTitle: '‚úÖ Translation Results',
                hashtagResultTitle: '‚úÖ Hashtag Results',
                pasteContent: 'Paste Original Content Here:',
                placeholderContent: 'Paste text here to rewrite (Text in [ ] will be preserved)',
                placeholderTranslation: 'Paste text here to translate',
                placeholderHashtag: 'Paste text here to find hashtags',
                voiceoverOptions: 'üéôÔ∏è Voiceover Options:',
                genderLabel: 'Voice Ref:',
                female: 'üíÅ‚Äç‚ôÄÔ∏è Female',
                male: 'ü§µ‚Äç‚ôÇÔ∏è Male',
                katoey: 'üè≥Ô∏è‚Äç‚ößÔ∏è Sassy/LGBTQ+',
                lengthTarget: 'Target Length:',
                captionOptions: 'üì∏ Caption Options:',
                maxCharsLabel: 'Max Characters:',
                toneLabel: '‚ú® Desired Tone:',
                toneFun: 'Fun & Playful',
                tonePolite: 'Polite & Formal',
                startRewrite: 'Start Rewrite',
                startTranslation: 'Start Translation',
                findHashtags: 'Find Viral Hashtags',
                loading: 'AI is casting spells...',
                originalContent: 'Original Content (Before)',
                rewrittenContent: 'Rewritten Result (After)',
                translatedContent: 'Translation Result (After)',
                hashtagContent: 'Hashtag Results',
                copyOriginal: 'Copy Original',
                copyScript: 'Copy Script',
                copyTranslation: 'Copy Translation',
                copyHashtagsOnly: 'Copy Hashtags Only',
                copyContentWithHashtags: 'Copy Content with Hashtags',
                rewriteAgain: 'Rewrite Again',
                backHome: 'Home',
                findNewHashtags: 'Find New Hashtags',
                adjustOptions: 'üõ†Ô∏è Adjust Options',
                saveAndRewrite: 'Save & Rewrite',
                themeTitle: 'Change Theme & Font üåà',
                selectTheme: 'Select Color Theme:',
                selectFont: 'Select Font:',
                customTheme: 'Custom Theme (2 Hex Codes):',
                saveClose: 'Save & Close üíæ',
                resetKey: 'Reset Key',
                popupRewrite: '‚ú® Rewrite This',
                alertTitle: '‚ö†Ô∏è Alert',
                alertSuccess: '‚úÖ Success',
                alertError: '‚ùå Error',
                noContent: 'Please enter original content first',
                copySuccess: 'Copied to clipboard',
                excessChars: '(Excess',
                chars: 'chars!)',
                totalTime: 'Total Time:',
                totalChars: 'Total Chars:',
                likeBtn: 'Like üëç',
                dislikeBtn: 'Dislike üëé',
                feedbackThanks: 'Thanks for your feedback!',
                customizeBtn: 'Customize Me',
                customizeTitle: 'Customize Your Preferences',
                customizeDesc: 'Add information you frequently use so AI can incorporate it into rewrites',
                customizePlaceholder: 'Enter information you want AI to remember, such as business name, writing style, preferred vocabulary, etc.',
                saveCustomData: 'Save Data',
                translateBtn: 'Translate TH-EN',
                translateLoading: 'Translating...',
                generateSelection: 'Generate Selection',
                termsBtn: 'Special Terms',
                termsTitle: 'Manage Special Terms',
                termsDesc: 'Add special terms for TH-EN translation in the format "TH = EN" or "EN = TH" (one term per line)',
                termsPlaceholder: 'e.g.\n‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û = Visual Thinking\nVisual Thinking = ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û',
                saveTerms: 'Save Terms',
                paraphraseBtn: 'Paraphrase',
                charsCount: 'chars',
                backupBtn: 'Backup Data',
                restoreBtn: 'Restore Data',
                backupSuccess: 'Backup completed successfully',
                restoreSuccess: 'Restore completed successfully',
                backupError: 'Error during backup',
                restoreError: 'Error during restore',
                additionalPrompt: 'Additional Prompt',
                additionalPromptPlaceholder: 'Additional Prompt',
                changeNickname: 'Change Nickname:',
                addEmojiLabel: 'Add Emoji to decorate content:'
            }
        };

        // --- Global State ---
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
        const APP_CONTAINER = document.getElementById('app-container');
        const THEME_MODAL = document.getElementById('theme-modal');
        const CUSTOMIZE_MODAL = document.getElementById('customize-modal');
        const TERMS_MODAL = document.getElementById('terms-modal');
        const APP_BODY = document.getElementById('appBody');
        const INITIAL_LOADING = document.getElementById('initial-loading');
        const FOOTER_INFO = document.getElementById('footer-info');
        
        let apiKey = localStorage.getItem('geminiApiKey') || '';
        let nickname = localStorage.getItem('aiRewriterNickname') || '';
        let userId = localStorage.getItem('aiRewriterUserId');
        let currentLang = localStorage.getItem('aiRewriterLang') || 'th'; // Default TH
        
        let page = apiKey ? 'home' : 'apiKeySetup';
        let isThemeModalOpen = false;
        let isCustomizeModalOpen = false;
        let isTermsModalOpen = false;
        let currentContent = ''; 
        let currentMode = '';
        
        let currentOptions = { 
            gender: 'female', 
            toneFun: false, 
            tonePolite: false, 
            lengthValue: 60, 
            maxChars: 1000,
            additionalPrompt: ''
        }; 
        
        let lastResponse = '';     
        let currentFeedback = null; // 'like' or 'dislike'
        let customUserData = localStorage.getItem('aiRewriterCustomData') || '';
        let customTerms = localStorage.getItem('aiRewriterCustomTerms') || '';
        let translatedContent = '';
        let isTranslating = false;
        let hashtagResult = '';

        // --- Generate User ID if missing ---
        if (!userId) {
            userId = 'User-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            localStorage.setItem('aiRewriterUserId', userId);
        }
        
        // --- Helper: Translation ---
        function t(key) {
            return translations[currentLang][key] || key;
        }

        // --- Helper: Language Detection ---
        function detectLanguage(text) {
            if (!text || text.trim() === '') return 'en'; // Default to English if empty
            
            // Count Thai and English characters
            let thaiCount = 0;
            let englishCount = 0;
            
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                // Thai characters range: 0x0E00-0x0E7F
                if (charCode >= 0x0E00 && charCode <= 0x0E7F) {
                    thaiCount++;
                } 
                // English characters (A-Z, a-z)
                else if ((charCode >= 65 && charCode <= 90) || (charCode >= 97 && charCode <= 122)) {
                    englishCount++;
                }
            }
            
            // Determine dominant language
            if (thaiCount > englishCount) {
                return 'th';
            } else if (englishCount > thaiCount) {
                return 'en';
            } else {
                // If equal or no clear dominant, use current UI language
                return currentLang;
            }
        }

        // --- Helper: History Saving ---
        function saveHistory(input, output, mode) {
            const historyItem = {
                timestamp: new Date().toISOString(),
                mode: mode,
                inputSnippet: input.substring(0, 50) + '...',
                outputSnippet: output.substring(0, 50) + '...'
            };
            
            let history = JSON.parse(localStorage.getItem('aiRewriterHistory') || '[]');
            history.unshift(historyItem);
            // Keep last 50 items
            if (history.length > 50) history = history.slice(0, 50);
            localStorage.setItem('aiRewriterHistory', JSON.stringify(history));
        }

        // --- Helper: Save Feedback ---
        function saveFeedback(feedback, content, result, mode) {
            const feedbackItem = {
                timestamp: new Date().toISOString(),
                mode: mode,
                feedback: feedback,
                originalContent: content,
                rewrittenContent: result
            };
            
            let feedbacks = JSON.parse(localStorage.getItem('aiRewriterFeedbacks') || '[]');
            feedbacks.unshift(feedbackItem);
            // Keep last 100 feedbacks
            if (feedbacks.length > 100) feedbacks = feedbacks.slice(0, 100);
            localStorage.setItem('aiRewriterFeedbacks', JSON.stringify(feedbacks));
            
            // Show thank you message
            showCustomMessage(t('alertSuccess'), t('feedbackThanks'));
        }

        // --- Themes & Fonts ---
        const themes = {
            'pinkOrange': { 
                key: 'pinkOrange',
                name: 'Pink to Orange', 
                bgStart: '#ee0979', 
                bgEnd: '#ff6a00', 
                primary: '#7F5FFF', 
                secondary: '#00BFFF', 
                cardColor: '#FFFFFF', 
                textColor: '#000000' 
            },
            'purpleTeal': { 
                key: 'purpleTeal',
                name: 'Purple to Teal', 
                bgStart: '#fc00ff', 
                bgEnd: '#00dbde', 
                primary: '#E54099', 
                secondary: '#00A6A6', 
                cardColor: '#FFFFFF', 
                textColor: '#000000' 
            },
            'blueDarkBlue': { 
                key: 'blueDarkBlue',
                name: 'Blue to Dark Blue', 
                bgStart: '#1488CC', 
                bgEnd: '#2B32B2', 
                primary: '#E56D55', 
                secondary: '#E5D0BF', 
                cardColor: '#FFFFFF', 
                textColor: '#000000' 
            },
            'grayDarkGray': { 
                key: 'grayDarkGray',
                name: 'Gray to Dark Gray', 
                bgStart: '#536976', 
                bgEnd: '#292E49', 
                primary: '#E54040', 
                secondary: '#4A4A4A', 
                cardColor: '#FFFFFF', 
                textColor: '#000000' 
            }
        };
        const fonts = { 'Anuphan': 'Anuphan', 'Bai Jamjuree': 'Bai Jamjuree', 'Sarabun': 'Sarabun' };

        let currentThemeKey = localStorage.getItem('currentTheme') || 'pinkOrange';
        let currentFont = localStorage.getItem('currentFont') || 'Anuphan';

        // --- Core Functions ---
        function applyTheme(theme, font) {
            const root = document.documentElement;
            root.style.setProperty('--bg-start', theme.bgStart);
            root.style.setProperty('--bg-end', theme.bgEnd);
            root.style.setProperty('--accent-primary', theme.primary);
            root.style.setProperty('--accent-secondary', theme.secondary);
            root.style.setProperty('--card-color', theme.cardColor);
            root.style.setProperty('--text-color', theme.textColor);
            localStorage.setItem('currentTheme', theme.key || currentThemeKey);
            
            APP_BODY.classList.remove('font-anuphan', 'font-bai-jamjuree', 'font-sarabun'); 
            APP_BODY.classList.add(`font-${font.toLowerCase().replace(/\s/g, '-')}`);
            localStorage.setItem('currentFont', currentFont);
            currentFont = font;
        }

        function formatContentForDisplay(content) {
            if (!content) return '';
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á - ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏à‡∏∏‡∏î
            let lines = content.split('\n');
            let result = [];
            let emptyLineCount = 0;
            
            for (let i = 0; i < lines.length; i++) {
                // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏ï‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)
                if (lines[i].trim() === '') {
                    emptyLineCount++;
                    // ‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á
                    if (emptyLineCount === 1) {
                        result.push('');
                    }
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    emptyLineCount = 0; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
                    result.push(lines[i]);
                }
            }
            
            // ‡∏£‡∏ß‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            return result.join('\n');
        }
        
        function formatSeconds(seconds) {
            if (seconds === 0) return '0 s';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            let parts = [];
            if (minutes > 0) parts.push(`${minutes}m`);
            if (remainingSeconds > 0) parts.push(`${remainingSeconds}s`);
            return parts.join(' ');
        }

        function calculateReadingTime(script) {
            if (!script) return { totalSeconds: 0, formatted: '0s' };
            const cleanOutside = script.replace(/\[([^\]]*)\]/g, '').replace(/[\s\n.,?!:;]/g, '');
            const timeOutside = cleanOutside.length / 18;
            const totalSeconds = Math.round(timeOutside);
            return { totalSeconds: totalSeconds, formatted: formatSeconds(totalSeconds) };
        }

        // --- Selection Popup Functions ---
        function setupSelectionPopup() {
            const textareas = ['rewrittenContentTextarea', 'translatedContentTextarea', 'hashtagResultTextarea'];
            
            textareas.forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    textarea.addEventListener('mouseup', function(e) {
                        const selection = window.getSelection().toString();
                        if (selection.length > 5) { // Only show for selections longer than 5 characters
                            showSelectionPopup(selection, e.clientX, e.clientY, id);
                        } else {
                            hideSelectionPopup();
                        }
                    });
                    
                    textarea.addEventListener('mousedown', function() {
                        // Hide popup when user starts new selection
                        setTimeout(hideSelectionPopup, 100);
                    });
                }
            });
            
            // Hide popup when clicking elsewhere
            document.addEventListener('mousedown', function(e) {
                if (!e.target.closest('.selection-popup') && !e.target.matches('textarea')) {
                    hideSelectionPopup();
                }
            });
        }

        function showSelectionPopup(selectedText, x, y, textareaId) {
            hideSelectionPopup();
            
            const popup = document.createElement('div');
            popup.className = 'selection-popup';
            popup.id = 'selectionPopup';
            
            // Calculate position to ensure popup stays within viewport
            const popupWidth = 250;
            const popupHeight = 120;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let adjustedX = x - 10;
            let adjustedY = y - popupHeight;
            
            // Ensure popup doesn't go off the right edge
            if (adjustedX + popupWidth > viewportWidth) {
                adjustedX = viewportWidth - popupWidth - 10;
            }
            
            // Ensure popup doesn't go off the left edge
            if (adjustedX < 10) {
                adjustedX = 10;
            }
            
            // Ensure popup doesn't go off the top edge
            if (adjustedY < 10) {
                adjustedY = y + 20;
            }
            
            // Ensure popup doesn't go off the bottom edge
            if (adjustedY + popupHeight > viewportHeight) {
                adjustedY = viewportHeight - popupHeight - 10;
            }
            
            popup.style.left = adjustedX + 'px';
            popup.style.top = adjustedY + 'px';
            
            popup.innerHTML = `
                <button onclick="generateSelectedText('${textareaId}')">
                    <i data-lucide="sparkles" class="w-3 h-3"></i> ${t('generateSelection')}
                </button>
                <textarea id="selectionPrompt" placeholder="${t('additionalPromptPlaceholder')}" class="w-full"></textarea>
            `;
            
            document.body.appendChild(popup);
            lucide.createIcons();
            
            // Store current selection info
            window.currentSelection = {
                text: selectedText,
                textareaId: textareaId
            };
        }

        function hideSelectionPopup() {
            const popup = document.getElementById('selectionPopup');
            if (popup) {
                popup.remove();
            }
            window.currentSelection = null;
        }

        window.generateSelectedText = async function(textareaId) {
            if (!window.currentSelection) return;
            
            const selectedText = window.currentSelection.text;
            const additionalPrompt = document.getElementById('selectionPrompt').value;
            hideSelectionPopup();
            
            try {
                let prompt = `Rewrite the following selected text to make it better while maintaining the same meaning and style: "${selectedText}"`;
                
                if (additionalPrompt) {
                    prompt += ` Additional instructions: ${additionalPrompt}`;
                }
                
                const result = await callGeminiAPI(selectedText, prompt);
                
                // Replace the selected text in the textarea
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const startPos = textarea.selectionStart;
                    const endPos = textarea.selectionEnd;
                    
                    const currentValue = textarea.value;
                    const newValue = currentValue.substring(0, startPos) + 
                                    result.text + 
                                    currentValue.substring(endPos);
                    
                    textarea.value = newValue;
                    
                    // Update the corresponding content variable
                    if (textareaId === 'rewrittenContentTextarea') {
                        lastResponse = newValue;
                    } else if (textareaId === 'translatedContentTextarea') {
                        translatedContent = newValue;
                    } else if (textareaId === 'hashtagResultTextarea') {
                        hashtagResult = newValue;
                    }
                }
                
                showCustomMessage(t('alertSuccess'), 'Selected text rewritten successfully!');
            } catch (error) {
                showCustomMessage(t('alertError'), 'Error rewriting selection: ' + error.message);
            }
        };

        // --- Backup & Restore Functions ---
        window.backupData = function() {
            try {
                const data = {
                    user: nickname || userId,
                    customTerms: customTerms,
                    customUserData: customUserData,
                    apiKey: apiKey,
                    currentLang: currentLang,
                    currentTheme: currentThemeKey,
                    currentFont: currentFont,
                    nickname: nickname,
                    timestamp: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai_rewriter_backup_${nickname || userId}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showCustomMessage(t('alertSuccess'), t('backupSuccess'));
            } catch (error) {
                console.error('Backup error:', error);
                showCustomMessage(t('alertError'), t('backupError'));
            }
        };

        window.restoreData = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.txt';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate backup data structure
                        if (typeof data !== 'object') {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Restore data with validation
                        if (data.customTerms !== undefined && typeof data.customTerms === 'string') {
                            customTerms = data.customTerms;
                            localStorage.setItem('aiRewriterCustomTerms', customTerms);
                        }
                        
                        if (data.customUserData !== undefined && typeof data.customUserData === 'string') {
                            customUserData = data.customUserData;
                            localStorage.setItem('aiRewriterCustomData', customUserData);
                        }
                        
                        if (data.apiKey !== undefined && typeof data.apiKey === 'string') {
                            apiKey = data.apiKey;
                            localStorage.setItem('geminiApiKey', apiKey);
                        }
                        
                        if (data.currentLang !== undefined && (data.currentLang === 'th' || data.currentLang === 'en')) {
                            currentLang = data.currentLang;
                            localStorage.setItem('aiRewriterLang', currentLang);
                        }
                        
                        if (data.currentTheme !== undefined && themes[data.currentTheme]) {
                            currentThemeKey = data.currentTheme;
                            localStorage.setItem('currentTheme', currentThemeKey);
                            applyTheme(themes[currentThemeKey], currentFont);
                        }
                        
                        if (data.currentFont !== undefined && fonts[data.currentFont]) {
                            currentFont = data.currentFont;
                            localStorage.setItem('currentFont', currentFont);
                        }
                        
                        if (data.nickname !== undefined && typeof data.nickname === 'string') {
                            nickname = data.nickname;
                            localStorage.setItem('aiRewriterNickname', nickname);
                        }
                        
                        // Update page state based on restored API key
                        page = apiKey ? 'home' : 'apiKeySetup';
                        
                        showCustomMessage(t('alertSuccess'), t('restoreSuccess'));
                        renderPage();
                    } catch (error) {
                        console.error('Restore error:', error);
                        showCustomMessage(t('alertError'), t('restoreError') + ': ' + error.message);
                    }
                };
                
                reader.onerror = function() {
                    showCustomMessage(t('alertError'), t('restoreError') + ': Cannot read file');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        };

        // --- API Call ---
        async function callGeminiAPI(userPrompt, systemPrompt) {
            const fullApiUrl = API_URL + apiKey;
            
            let toneInstructions = [];
            if (currentOptions.toneFun) toneInstructions.push("‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏∏‡∏Å ‡∏ï‡∏•‡∏Å‡∏Ç‡∏ö‡∏Ç‡∏±‡∏ô ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô");
            if (currentOptions.tonePolite) toneInstructions.push("‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£");
            
            if (toneInstructions.length > 0) {
                systemPrompt += " ‡πÇ‡∏ó‡∏ô: " + toneInstructions.join(' ‡πÅ‡∏•‡∏∞ ') + ".";
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å)
            if (customUserData && currentMode !== 'translation' && currentMode !== 'hashtag') {
                systemPrompt += ` ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ô‡∏≥‡∏°‡∏≤‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤: ${customUserData}`;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤)
            if (customTerms && currentMode === 'translation') {
                systemPrompt += ` ‡∏Ñ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•: ${customTerms}`;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° prompt ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (currentOptions.additionalPrompt) {
                systemPrompt += ` ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${currentOptions.additionalPrompt}`;
            }

            // REQUIREMENT 2: Strict NO Descriptions
            const strictRules = "‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û, ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö ( ) ‡∏´‡∏£‡∏∑‡∏≠ [ ] ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.";
            
            systemPrompt = strictRules + "\n" + systemPrompt;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const fetchResponse = await fetch(fullApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!fetchResponse.ok) throw new Error('API Error: ' + fetchResponse.status);
                const response = await fetchResponse.json();
                const text = response.candidates?.[0]?.content?.parts?.[0]?.text || 'Error generation';
                
                // Save History
                saveHistory(userPrompt, text, currentMode);
                
                return { text };
            } catch (error) {
                throw error;
            }
        }

        // --- Render Functions ---

        window.toggleLanguage = function() {
            currentLang = currentLang === 'th' ? 'en' : 'th';
            localStorage.setItem('aiRewriterLang', currentLang);
            renderPage();
        }

        function renderPage() {
            // Hide initial loading immediately
            if(INITIAL_LOADING) INITIAL_LOADING.style.display = 'none';
            APP_CONTAINER.innerHTML = '';
            
            // Update Lang Display
            document.getElementById('langDisplay').textContent = currentLang.toUpperCase();
            
            // Update Footer
            const displayName = nickname || userId;
            FOOTER_INFO.textContent = apiKey ? `User ID: ${displayName}` : '';
            
            // Header
            let headerHtml = '';
            if (page !== 'apiKeySetup' && page !== 'home') {
                headerHtml = `
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex space-x-2">
                            <button onclick="goBack()" class="btn-secondary flex items-center p-2"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <button onclick="goHome()" class="home-btn p-2 flex items-center"><i data-lucide="home" class="w-5 h-5"></i></button>
                        </div>
                        <h2 class="text-3xl font-bold text-center">${getPageTitle(page)}</h2>
                        <div class="flex space-x-2">
                            <button onclick="goToTermsModal()" class="terms-btn p-2 flex items-center"><i data-lucide="book-open" class="w-5 h-5 mr-1"></i> ${t('termsBtn')}</button>
                            <button onclick="goToCustomizeModal()" class="customize-btn p-2 flex items-center"><i data-lucide="settings" class="w-5 h-5 mr-1"></i> ${t('customizeBtn')}</button>
                            <button onclick="goToThemeModal()" class="btn-secondary p-2 flex items-center"><i data-lucide="palette" class="w-5 h-5 mr-1"></i> Theme</button>
                        </div>
                    </div>
                `;
            } else {
                headerHtml = `
                    <div class="flex justify-between items-center mb-6">
                        <div></div>
                        <h2 class="text-3xl font-bold text-center">${getPageTitle(page)}</h2>
                        ${page !== 'apiKeySetup' ? `
                            <div class="flex space-x-2">
                                <button onclick="goToTermsModal()" class="terms-btn p-2 flex items-center"><i data-lucide="book-open" class="w-5 h-5 mr-1"></i> ${t('termsBtn')}</button>
                                <button onclick="goToCustomizeModal()" class="customize-btn p-2 flex items-center"><i data-lucide="settings" class="w-5 h-5 mr-1"></i> ${t('customizeBtn')}</button>
                                <button onclick="goToThemeModal()" class="btn-secondary p-2 flex items-center"><i data-lucide="palette" class="w-5 h-5 mr-1"></i> Theme</button>
                            </div>
                        ` : '<div></div>'}
                    </div>
                `;
            }
            APP_CONTAINER.insertAdjacentHTML('afterbegin', headerHtml);

            if (page === 'apiKeySetup') renderApiKeySetup();
            else if (page === 'home') renderHome();
            else if (page === 'inputForm') renderInputForm();
            else if (page === 'result') renderResult();
            
            lucide.createIcons();
            
            if (isThemeModalOpen) renderThemeModal();
            else if (isCustomizeModalOpen) renderCustomizeModal();
            else if (isTermsModalOpen) renderTermsModal();
            else {
                THEME_MODAL.classList.add('hidden');
                CUSTOMIZE_MODAL.classList.add('hidden');
                TERMS_MODAL.classList.add('hidden');
            }

            // Setup selection popup for result page
            if (page === 'result') {
                setTimeout(setupSelectionPopup, 100);
            }
        }

        function getPageTitle(p) {
            if (p === 'apiKeySetup') return t('welcomeTitle');
            if (p === 'home') return t('homeTitle');
            if (p === 'inputForm') {
                if (currentMode === 'caption') return t('inputCaptionTitle');
                if (currentMode === 'voiceover') return t('inputVoiceoverTitle');
                if (currentMode === 'translation') return t('inputTranslationTitle');
                if (currentMode === 'hashtag') return t('inputHashtagTitle');
            }
            if (p === 'result') {
                if (currentMode === 'translation') return t('translatedResultTitle');
                if (currentMode === 'hashtag') return t('hashtagResultTitle');
                return t('resultTitle');
            }
            return 'AI Assistant';
        }

        function renderApiKeySetup() {
            APP_CONTAINER.innerHTML += `
                <p class="mb-4 text-center">${t('enterApiKey')}</p>
                <input type="text" id="apiKeyInput" placeholder="${t('apiKeyPlaceholder')}" class="w-full mb-4" value="${apiKey}">
                <input type="text" id="nicknameInput" placeholder="${t('nicknamePlaceholder')}" class="w-full mb-4" value="${nickname}">
                <button onclick="saveApiKey()" class="btn-primary w-full">${t('saveKeyBtn')}</button>
                <button onclick="restoreData()" class="restore-btn w-full mt-4 flex items-center justify-center">
                    <i data-lucide="upload" class="w-5 h-5 mr-2"></i> ${t('restoreBtn')}
                </button>
                <button onclick="resetApiKey()" class="text-xs text-red-500 mt-4 underline hover:text-red-700 w-full text-center block">${t('resetKeyLink')}</button>
            `;
        }

        function renderHome() {
            APP_CONTAINER.innerHTML += `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4">
                    <button onclick="selectMode('caption')" class="hashtag-btn text-left flex flex-col items-center justify-center p-6 h-40">
                        <i data-lucide="message-square" class="w-8 h-8 mb-2"></i>
                        <span class="text-xl font-bold text-center">${t('captionMode')}</span>
                        <span class="text-xs font-light text-center opacity-90 mt-1">${t('captionDesc')}</span>
                    </button>
                    <button onclick="selectMode('voiceover')" class="hashtag-btn text-left flex flex-col items-center justify-center p-6 h-40">
                        <i data-lucide="mic" class="w-8 h-8 mb-2"></i>
                        <span class="text-xl font-bold text-center">${t('voiceoverMode')}</span>
                        <span class="text-xs font-light text-center opacity-90 mt-1">${t('voiceoverDesc')}</span>
                    </button>
                    <button onclick="selectMode('translation')" class="hashtag-btn text-left flex flex-col items-center justify-center p-6 h-40">
                        <i data-lucide="languages" class="w-8 h-8 mb-2"></i>
                        <span class="text-xl font-bold text-center">${t('translationMode')}</span>
                        <span class="text-xs font-light text-center opacity-90 mt-1">${t('translationDesc')}</span>
                    </button>
                    <button onclick="selectMode('hashtag')" class="hashtag-btn text-left flex flex-col items-center justify-center p-6 h-40">
                        <i data-lucide="hash" class="w-8 h-8 mb-2"></i>
                        <span class="text-xl font-bold text-center">${t('hashtagMode')}</span>
                        <span class="text-xs font-light text-center opacity-90 mt-1">${t('hashtagDesc')}</span>
                    </button>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-center mb-4">Backup & Restore</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="backupData()" class="backup-btn flex items-center justify-center">
                            <i data-lucide="download" class="w-5 h-5 mr-2"></i> ${t('backupBtn')}
                        </button>
                        <button onclick="restoreData()" class="restore-btn flex items-center justify-center">
                            <i data-lucide="upload" class="w-5 h-5 mr-2"></i> ${t('restoreBtn')}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderThemeModal() {
            let themeListHtml = '';
            for (const key in themes) {
                const theme = themes[key];
                const isActive = key === currentThemeKey;
                themeListHtml += `
                    <div onclick="changeTheme('${key}')" class="theme-option flex flex-col items-center p-3 border rounded-lg cursor-pointer transition ${isActive ? 'selected' : 'border-transparent hover:bg-gray-50'}">
                        <div class="font-semibold text-sm mb-2 text-black">${theme.name}</div>
                        <div class="theme-circle ${isActive ? 'selected' : ''}" style="background: linear-gradient(135deg, ${theme.bgStart}, ${theme.bgEnd});"></div>
                    </div>
                `;
            }
            
            let fontListHtml = '';
            for (const key in fonts) {
                const isActive = key === currentFont;
                fontListHtml += `<option value="${key}" ${isActive ? 'selected' : ''}>${key}</option>`;
            }

            THEME_MODAL.innerHTML = `
                <div class="glass-card w-full max-w-4xl bg-white text-black p-6">
                    <h2 class="text-xl font-bold text-center mb-4">${t('themeTitle')}</h2>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-semibold mb-2">${t('changeNickname')}</p>
                            <input type="text" id="themeNicknameInput" placeholder="${t('nicknamePlaceholder')}" class="w-full text-black text-sm" value="${nickname}">
                        </div>
                        <div>
                            <p class="text-sm font-semibold mb-2">${t('selectTheme')}</p>
                            <div class="flex flex-wrap justify-center gap-4">${themeListHtml}</div>
                        </div>
                        <div>
                            <p class="text-sm font-semibold mb-2">${t('selectFont')}</p>
                            <select id="fontSelect" onchange="changeFont(this.value)" class="w-full text-black text-sm">${fontListHtml}</select>
                        </div>
                        <div class="pt-3 border-t mt-2">
                             <p class="text-sm font-semibold mb-2">${t('customTheme')}</p>
                             <div class="flex gap-2">
                                <input type="text" id="customColor1" placeholder="#Color1" class="w-1/2 text-sm">
                                <input type="text" id="customColor2" placeholder="#Color2" class="w-1/2 text-sm">
                             </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between items-center border-t pt-4">
                        <button onclick="saveCustomThemeAndClose()" class="btn-primary w-2/3 mr-2 text-sm">${t('saveClose')}</button>
                        <button onclick="resetKeyFromThemeModal()" class="btn-secondary w-1/3 ml-2 bg-red-500 text-white hover:bg-red-600 text-sm flex justify-center items-center">
                            <i data-lucide="key-round" class="w-3 h-3 mr-1"></i> ${t('resetKey')}
                        </button>
                    </div>
                </div>
            `;
            THEME_MODAL.classList.remove('hidden');
            lucide.createIcons();
        }

        function renderCustomizeModal() {
            CUSTOMIZE_MODAL.innerHTML = `
                <div class="glass-card w-full max-w-lg bg-white text-black p-6">
                    <h2 class="text-xl font-bold text-center mb-4">${t('customizeTitle')}</h2>
                    <div class="space-y-4">
                        <p class="text-sm">${t('customizeDesc')}</p>
                        <textarea id="customUserData" rows="8" placeholder="${t('customizePlaceholder')}" class="w-full custom-scrollbar">${customUserData}</textarea>
                    </div>
                    <div class="mt-6 flex justify-between items-center border-t pt-4">
                        <button onclick="saveCustomDataAndClose()" class="customize-btn w-full text-sm">${t('saveCustomData')}</button>
                    </div>
                </div>
            `;
            CUSTOMIZE_MODAL.classList.remove('hidden');
            lucide.createIcons();
        }

        function renderTermsModal() {
            TERMS_MODAL.innerHTML = `
                <div class="glass-card w-full max-w-lg bg-white text-black p-6">
                    <h2 class="text-xl font-bold text-center mb-4">${t('termsTitle')}</h2>
                    <div class="space-y-4">
                        <p class="text-sm">${t('termsDesc')}</p>
                        <textarea id="customTermsData" rows="8" placeholder="${t('termsPlaceholder')}" class="w-full custom-scrollbar">${customTerms}</textarea>
                    </div>
                    <div class="mt-6 flex justify-between items-center border-t pt-4">
                        <button onclick="saveCustomTermsAndClose()" class="terms-btn w-full text-sm">${t('saveTerms')}</button>
                    </div>
                </div>
            `;
            TERMS_MODAL.classList.remove('hidden');
            lucide.createIcons();
        }

        function renderInputForm() {
            let specificOptions = '';
            let placeholderText = t('placeholderContent');
            
            if (currentMode === 'voiceover') {
                 specificOptions = `
                    <p class="font-semibold mt-4 mb-2">${t('voiceoverOptions')}</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold text-sm">${t('genderLabel')}</label>
                            <select id="genderSelect" class="w-full">
                                <option value="female" ${currentOptions.gender === 'female' ? 'selected' : ''}>${t('female')}</option>
                                <option value="male" ${currentOptions.gender === 'male' ? 'selected' : ''}>${t('male')}</option>
                                <option value="katoey" ${currentOptions.gender === 'katoey' ? 'selected' : ''}>${t('katoey')}</option>
                            </select>
                        </div>
                        <div>
                             <label class="block mb-2 font-semibold text-sm">${t('lengthTarget')}</label>
                             <div class="flex items-center gap-2">
                                <input type="range" min="5" max="300" value="${currentOptions.lengthValue}" id="lengthSlider">
                                <span id="lenVal" class="text-sm font-bold w-10">${currentOptions.lengthValue}s</span>
                             </div>
                        </div>
                    </div>
                 `;
            } else if (currentMode === 'caption') {
                 specificOptions = `
                    <p class="font-semibold mt-4 mb-2">${t('captionOptions')}</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block mb-2 font-semibold text-sm">${t('genderLabel')}</label>
                            <select id="genderSelect" class="w-full">
                                <option value="female" ${currentOptions.gender === 'female' ? 'selected' : ''}>${t('female')}</option>
                                <option value="male" ${currentOptions.gender === 'male' ? 'selected' : ''}>${t('male')}</option>
                                <option value="katoey" ${currentOptions.gender === 'katoey' ? 'selected' : ''}>${t('katoey')}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 font-semibold text-sm">${t('maxCharsLabel')}</label>
                            <div class="flex items-center gap-2">
                                <input type="range" min="100" max="2200" step="50" value="${currentOptions.maxChars}" id="charsSlider">
                                <span id="charVal" class="text-sm font-bold w-12">${currentOptions.maxChars}</span>
                            </div>
                        </div>
                    </div>
                 `;
            } else if (currentMode === 'translation') {
                placeholderText = t('placeholderTranslation');
            } else if (currentMode === 'hashtag') {
                placeholderText = t('placeholderHashtag');
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Emoji ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å
                specificOptions = `
                    <div class="mt-4">
                        <label class="block mb-2 font-semibold text-sm">${t('addEmojiLabel')}</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button type="button" onclick="addEmoji('üòä')" class="emoji-btn">üòä</button>
                            <button type="button" onclick="addEmoji('üòÇ')" class="emoji-btn">üòÇ</button>
                            <button type="button" onclick="addEmoji('‚ù§Ô∏è')" class="emoji-btn">‚ù§Ô∏è</button>
                            <button type="button" onclick="addEmoji('üî•')" class="emoji-btn">üî•</button>
                            <button type="button" onclick="addEmoji('üëç')" class="emoji-btn">üëç</button>
                            <button type="button" onclick="addEmoji('üéâ')" class="emoji-btn">üéâ</button>
                            <button type="button" onclick="addEmoji('üôè')" class="emoji-btn">üôè</button>
                            <button type="button" onclick="addEmoji('‚≠ê')" class="emoji-btn">‚≠ê</button>
                            <button type="button" onclick="addEmoji('‚ú®')" class="emoji-btn">‚ú®</button>
                            <button type="button" onclick="addEmoji('üí´')" class="emoji-btn">üí´</button>
                        </div>
                    </div>
                `;
            }

            // Additional prompt textarea
            const additionalPromptHtml = `
                <div class="mt-4">
                    <label class="block mb-2 font-semibold text-sm">${t('additionalPrompt')}</label>
                    <textarea id="additionalPromptInput" placeholder="${t('additionalPromptPlaceholder')}" class="w-full custom-scrollbar" rows="2">${currentOptions.additionalPrompt}</textarea>
                </div>
            `;

            APP_CONTAINER.innerHTML += `
                <div class="space-y-4">
                    <p class="font-semibold text-xl">${t('pasteContent')}</p>
                    <textarea id="sourceContent" rows="8" placeholder="${placeholderText}" class="w-full custom-scrollbar">${currentContent}</textarea>
                    ${specificOptions}
                    ${currentMode !== 'hashtag' ? `
                        <p class="font-semibold mt-6 mb-2">${t('toneLabel')}</p>
                        <div class="grid grid-cols-2 gap-4">
                            <button id="toneFunBtn" class="toggle-btn ${currentOptions.toneFun ? 'active' : ''}"><i data-lucide="laugh" class="w-4 h-4 mr-2 inline-block"></i> ${t('toneFun')}</button>
                            <button id="tonePoliteBtn" class="toggle-btn ${currentOptions.tonePolite ? 'active' : ''}"><i data-lucide="hand-heart" class="w-4 h-4 mr-2 inline-block"></i> ${t('tonePolite')}</button>
                        </div>
                    ` : ''}
                    ${additionalPromptHtml}
                    <div id="loading" class="hidden flex justify-center items-center p-4"><div class="spinner mr-3"></div><span class="text-lg">${t('loading')}</span></div>
                    <button onclick="generateContent(true)" class="btn-primary w-full mt-6">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2 inline-block"></i> 
                        ${currentMode === 'translation' ? t('startTranslation') : currentMode === 'hashtag' ? t('findHashtags') : t('startRewrite')}
                    </button>
                </div>
            `;

            // Add event listeners for tone buttons (if applicable)
            if (currentMode !== 'hashtag') {
                document.getElementById('toneFunBtn').addEventListener('click', function() {
                    currentOptions.toneFun = !currentOptions.toneFun;
                    this.classList.toggle('active', currentOptions.toneFun);
                });

                document.getElementById('tonePoliteBtn').addEventListener('click', function() {
                    currentOptions.tonePolite = !currentOptions.tonePolite;
                    this.classList.toggle('active', currentOptions.tonePolite);
                });
            }

            // Add event listeners for sliders and selects
            if (currentMode === 'voiceover') {
                const lengthSlider = document.getElementById('lengthSlider');
                const lenVal = document.getElementById('lenVal');
                const genderSelect = document.getElementById('genderSelect');
                
                lengthSlider.addEventListener('input', function() {
                    currentOptions.lengthValue = this.value;
                    lenVal.textContent = this.value + 's';
                });
                
                genderSelect.addEventListener('change', function() {
                    currentOptions.gender = this.value;
                });
            } else if (currentMode === 'caption') {
                const charsSlider = document.getElementById('charsSlider');
                const charVal = document.getElementById('charVal');
                const genderSelect = document.getElementById('genderSelect');
                
                charsSlider.addEventListener('input', function() {
                    currentOptions.maxChars = this.value;
                    charVal.textContent = this.value;
                });
                
                genderSelect.addEventListener('change', function() {
                    currentOptions.gender = this.value;
                });
            }

            // Add event listener for additional prompt
            const additionalPromptInput = document.getElementById('additionalPromptInput');
            additionalPromptInput.addEventListener('input', function() {
                currentOptions.additionalPrompt = this.value;
            });
        }

        function renderResult() {
            const isVoiceover = currentMode === 'voiceover';
            const isCaption = currentMode === 'caption';
            const isTranslation = currentMode === 'translation';
            const isHashtag = currentMode === 'hashtag';
            
            // Calculate stats
            const { formatted } = calculateReadingTime(lastResponse);
            const charCount = lastResponse.length;
            const excessChars = isCaption && charCount > currentOptions.maxChars ? charCount - currentOptions.maxChars : 0;
            
            // Stats bar
            const statsBar = isVoiceover ? `
                <div class="stats-bar mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center"><i data-lucide="clock" class="w-4 h-4 mr-1 text-blue-500"></i> <span class="font-semibold">${t('totalTime')}:</span> <span class="text-blue-500 ml-1">${formatted}</span></div>
                    </div>
                </div>
            ` : isCaption ? `
                <div class="stats-bar mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center"><i data-lucide="type" class="w-4 h-4 mr-1 text-blue-500"></i> <span class="font-semibold">${t('totalChars')}:</span> <span class="text-blue-500 ml-1">${charCount}</span></div>
                        ${excessChars > 0 ? `<div class="flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1 text-red-500"></i> <span class="font-semibold text-red-500">${t('excessChars')} ${excessChars} ${t('chars')}</span></div>` : ''}
                    </div>
                </div>
            ` : '';

            // Options Section (not for hashtag mode)
            let optionsSection = '';
            if ((isVoiceover || isCaption || isTranslation) && !isHashtag) {
                let specificOptions = '';
                
                if (isVoiceover) {
                    specificOptions = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 font-semibold text-sm">${t('genderLabel')}</label>
                                <select id="resultGenderSelect" class="w-full">
                                    <option value="female" ${currentOptions.gender === 'female' ? 'selected' : ''}>${t('female')}</option>
                                    <option value="male" ${currentOptions.gender === 'male' ? 'selected' : ''}>${t('male')}</option>
                                    <option value="katoey" ${currentOptions.gender === 'katoey' ? 'selected' : ''}>${t('katoey')}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2 font-semibold text-sm">${t('lengthTarget')}</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="5" max="300" value="${currentOptions.lengthValue}" id="resultLengthSlider">
                                    <span id="resultLenVal" class="text-sm font-bold w-10">${currentOptions.lengthValue}s</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (isCaption) {
                    specificOptions = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 font-semibold text-sm">${t('genderLabel')}</label>
                                <select id="resultGenderSelect" class="w-full">
                                    <option value="female" ${currentOptions.gender === 'female' ? 'selected' : ''}>${t('female')}</option>
                                    <option value="male" ${currentOptions.gender === 'male' ? 'selected' : ''}>${t('male')}</option>
                                    <option value="katoey" ${currentOptions.gender === 'katoey' ? 'selected' : ''}>${t('katoey')}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2 font-semibold text-sm">${t('maxCharsLabel')}</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="100" max="2200" step="50" value="${currentOptions.maxChars}" id="resultCharsSlider">
                                    <span id="resultCharVal" class="text-sm font-bold w-12">${currentOptions.maxChars}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                optionsSection = `
                    <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow border border-gray-200">
                        ${statsBar}
                        <h3 class="font-semibold text-lg mb-3">${t('adjustOptions')}</h3>
                        ${specificOptions}
                        <div class="mt-4">
                            <p class="font-semibold mb-2">${t('toneLabel')}</p>
                            <div class="grid grid-cols-2 gap-4">
                                <button id="resultToneFunBtn" class="toggle-btn ${currentOptions.toneFun ? 'active' : ''}"><i data-lucide="laugh" class="w-4 h-4 mr-2 inline-block"></i> ${t('toneFun')}</button>
                                <button id="resultTonePoliteBtn" class="toggle-btn ${currentOptions.tonePolite ? 'active' : ''}"><i data-lucide="hand-heart" class="w-4 h-4 mr-2 inline-block"></i> ${t('tonePolite')}</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block mb-2 font-semibold text-sm">${t('additionalPrompt')}</label>
                            <textarea id="resultAdditionalPrompt" placeholder="${t('additionalPromptPlaceholder')}" class="w-full custom-scrollbar" rows="2">${currentOptions.additionalPrompt}</textarea>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="generateContent(false, true)" class="save-rewrite-btn flex-1"><i data-lucide="rotate-ccw" class="w-5 h-5 mr-2 inline-block"></i> ${t('saveAndRewrite')}</button>
                            ${!isTranslation ? `<button onclick="translateContent()" class="translate-btn flex-1"><i data-lucide="languages" class="w-5 h-5 mr-2 inline-block"></i> ${t('translateBtn')}</button>` : ''}
                        </div>
                    </div>
                `;
            }

            // Like/Dislike buttons (not for hashtag mode)
            const feedbackButtons = !isTranslation && !isHashtag ? `
                <div class="absolute top-2 right-2 z-10">
                    <button onclick="giveFeedback('like')" class="feedback-btn like-btn ${currentFeedback === 'like' ? 'active' : ''}">
                        <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                    </button>
                    <button onclick="giveFeedback('dislike')" class="feedback-btn dislike-btn ${currentFeedback === 'dislike' ? 'active' : ''}">
                        <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                    </button>
                </div>
            ` : '';

            // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å
            const hashtagResultSection = isHashtag ? `
                <div class="flex flex-col h-full relative">
                    <h3 class="font-semibold text-xl mb-3">
                        ${t('hashtagContent')}
                    </h3>
                    <div class="relative">
                        <textarea id="hashtagResultTextarea" rows="10" class="result-textarea-box custom-scrollbar flex-grow w-full">${formatContentForDisplay(hashtagResult)}</textarea>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="copyHashtagsOnly()" class="btn-primary flex-1 flex items-center justify-center">
                            <i data-lucide="copy" class="w-5 h-5 mr-1"></i> ${t('copyHashtagsOnly')}
                        </button>
                        <button onclick="copyContentWithHashtags()" class="hashtag-btn flex-1 flex items-center justify-center">
                            <i data-lucide="copy" class="w-5 h-5 mr-1"></i> ${t('copyContentWithHashtags')}
                        </button>
                    </div>
                </div>
            ` : '';

            // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤)
            const translationResultSection = isTranslation ? `
                <div class="flex flex-col h-full relative">
                    <h3 class="font-semibold text-xl mb-3">
                        ${t('translatedContent')}
                    </h3>
                    <div class="relative">
                        <textarea id="translatedContentTextarea" rows="10" class="result-textarea-box custom-scrollbar flex-grow w-full">${formatContentForDisplay(lastResponse)}</textarea>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="copyToClipboard('translatedContentTextarea')" class="btn-primary flex-1 flex items-center justify-center">
                            <i data-lucide="copy" class="w-5 h-5 mr-1"></i> ${t('copyTranslation')}
                        </button>
                        <button onclick="paraphraseTranslatedContent()" class="paraphrase-btn flex-1 flex items-center justify-center">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i> ${t('paraphraseBtn')}
                        </button>
                    </div>
                </div>
            ` : '';

            // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£ rewrite (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô)
            const rewriteResultSection = !isTranslation && !isHashtag ? `
                <div class="flex flex-col h-full relative">
                    <h3 class="font-semibold text-xl mb-3">
                        ${t('rewrittenContent')}
                        ${isCaption && excessChars > 0 ? `<span class="text-red-500 ml-2 font-bold">${t('excessChars')} ${excessChars} ${t('chars')}</span>` : ''}
                    </h3>
                    <div class="relative">
                        <textarea id="rewrittenContentTextarea" rows="10" class="result-textarea-box custom-scrollbar flex-grow w-full ${isCaption && excessChars > 0 ? 'excess-chars' : ''}">${formatContentForDisplay(lastResponse)}</textarea>
                        ${feedbackButtons}
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="copyToClipboard('rewrittenContentTextarea')" class="btn-primary flex-1 flex items-center justify-center">
                            <i data-lucide="copy" class="w-5 h-5 mr-1"></i> ${t('copyScript')}
                        </button>
                    </div>
                </div>
            ` : '';

            // ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
            const translationSection = (isCaption || isVoiceover) && translatedContent ? `
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-xl">${t('translatedContent')}</h3>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-semibold">${translatedContent.length} ${t('charsCount')}</span>
                            <button onclick="paraphraseTranslatedContent()" class="paraphrase-btn flex items-center">
                                <i data-lucide="refresh-cw" class="w-4 h-4 mr-1"></i> ${t('paraphraseBtn')}
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="translatedContentTextarea" rows="6" class="result-textarea-box custom-scrollbar w-full" readonly>${formatContentForDisplay(translatedContent)}</textarea>
                    </div>
                </div>
            ` : '';

            // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å)
            const findNewHashtagsButton = isHashtag ? `
                <div class="mt-6 flex justify-center">
                    <button onclick="generateContent(false, true)" class="hashtag-btn w-full">
                        <i data-lucide="hash" class="w-5 h-5 mr-2 inline-block"></i> ${t('findNewHashtags')}
                    </button>
                </div>
            ` : '';

            const mainContentHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Left: Original -->
                    <div class="flex flex-col h-full">
                        <h3 class="font-semibold text-xl mb-3">${t('originalContent')}</h3>
                        <textarea id="originalContentTextarea" rows="10" class="result-textarea-box custom-scrollbar flex-grow">${currentContent}</textarea>
                        <button onclick="copyToClipboard('originalContentTextarea')" class="btn-secondary w-full mt-2 flex items-center justify-center">
                            <i data-lucide="copy" class="w-5 h-5 mr-1"></i> ${t('copyOriginal')}
                        </button>
                    </div>
                    <!-- Right: Result -->
                    ${isHashtag ? hashtagResultSection : (isTranslation ? translationResultSection : rewriteResultSection)}
                </div>
                ${optionsSection}
                ${translationSection}
                ${findNewHashtagsButton}
            `;

            APP_CONTAINER.innerHTML += `<div class="pt-4">${mainContentHtml}</div>`;

            // Add event listeners for result page controls
            if ((isVoiceover || isCaption || isTranslation) && !isHashtag) {
                // Tone buttons
                document.getElementById('resultToneFunBtn').addEventListener('click', function() {
                    currentOptions.toneFun = !currentOptions.toneFun;
                    this.classList.toggle('active', currentOptions.toneFun);
                });

                document.getElementById('resultTonePoliteBtn').addEventListener('click', function() {
                    currentOptions.tonePolite = !currentOptions.tonePolite;
                    this.classList.toggle('active', currentOptions.tonePolite);
                });

                // Gender select
                if (isVoiceover || isCaption) {
                    const genderSelect = document.getElementById('resultGenderSelect');
                    genderSelect.addEventListener('change', function() {
                        currentOptions.gender = this.value;
                    });
                }

                // Sliders
                if (isVoiceover) {
                    const lengthSlider = document.getElementById('resultLengthSlider');
                    const lenVal = document.getElementById('resultLenVal');
                    
                    lengthSlider.addEventListener('input', function() {
                        currentOptions.lengthValue = this.value;
                        lenVal.textContent = this.value + 's';
                    });
                } else if (isCaption) {
                    const charsSlider = document.getElementById('resultCharsSlider');
                    const charVal = document.getElementById('resultCharVal');
                    
                    charsSlider.addEventListener('input', function() {
                        currentOptions.maxChars = this.value;
                        charVal.textContent = this.value;
                    });
                }

                // Additional prompt
                const additionalPrompt = document.getElementById('resultAdditionalPrompt');
                additionalPrompt.addEventListener('input', function() {
                    currentOptions.additionalPrompt = this.value;
                });
            }
        }

        // --- Controllers ---
        window.goHome = function() {
            page = 'home';
            currentContent = '';
            lastResponse = '';
            currentFeedback = null;
            translatedContent = '';
            hashtagResult = '';
            isTranslating = false;
            renderPage();
        }

        window.goBack = function() {
            if (page === 'result') {
                currentContent = document.getElementById('originalContentTextarea')?.value || currentContent;
                page = 'inputForm';
            } else if (page === 'inputForm') {
                page = 'home';
            }
            renderPage();
        }

        window.toggleTone = function(key) {
            currentOptions[key] = !currentOptions[key];
            // Don't re-render the whole page, just update the button state
            const button = document.getElementById(key + 'Btn');
            if (button) {
                button.classList.toggle('active', currentOptions[key]);
            }
        }

        window.selectMode = function(mode) {
            currentMode = mode;
            page = 'inputForm';
            currentContent = '';
            renderPage();
        }

        window.saveApiKey = function() {
            const val = document.getElementById('apiKeyInput').value.trim();
            const nick = document.getElementById('nicknameInput').value.trim();
            if(val) { 
                apiKey = val; 
                localStorage.setItem('geminiApiKey', apiKey); 
                if (nick) {
                    nickname = nick;
                    localStorage.setItem('aiRewriterNickname', nickname);
                }
                page = 'home'; 
                renderPage(); 
            }
        }
        window.resetApiKey = function() { 
            apiKey=''; 
            nickname='';
            localStorage.removeItem('geminiApiKey'); 
            localStorage.removeItem('aiRewriterNickname');
            page='apiKeySetup'; 
            renderPage(); 
        }
        window.resetKeyFromThemeModal = function() { isThemeModalOpen=false; THEME_MODAL.classList.add('hidden'); resetApiKey(); }
        window.goToThemeModal = function() { isThemeModalOpen=true; renderPage(); }
        window.goToCustomizeModal = function() { isCustomizeModalOpen=true; renderPage(); }
        window.goToTermsModal = function() { isTermsModalOpen=true; renderPage(); }
        window.closeThemeModal = function() { isThemeModalOpen=false; renderPage(); }
        window.closeCustomizeModal = function() { isCustomizeModalOpen=false; renderPage(); }
        window.closeTermsModal = function() { isTermsModalOpen=false; renderPage(); }
        window.changeTheme = function(key) { 
            currentThemeKey = key;
            applyTheme(themes[key], currentFont); 
            isThemeModalOpen=true; 
            renderPage(); 
        }
        window.changeFont = function(val) { applyTheme(themes[localStorage.getItem('currentTheme')||'pinkOrange'], val); isThemeModalOpen=true; renderPage(); }
        
        window.saveCustomThemeAndClose = function() {
            const color1 = document.getElementById('customColor1').value.trim();
            const color2 = document.getElementById('customColor2').value.trim();
            const newNickname = document.getElementById('themeNicknameInput').value.trim();
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
            if (newNickname) {
                nickname = newNickname;
                localStorage.setItem('aiRewriterNickname', nickname);
            }
            
            if (color1 && color2) {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ò‡∏µ‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
                const customTheme = {
                    key: 'custom',
                    bgStart: color1,
                    bgEnd: color2,
                    primary: '#7F5FFF',
                    secondary: '#00BFFF',
                    cardColor: '#FFFFFF',
                    textColor: '#000000'
                };
                applyTheme(customTheme, currentFont);
            }
            
            isThemeModalOpen = false;
            renderPage();
        }

        window.saveCustomDataAndClose = function() {
            customUserData = document.getElementById('customUserData').value.trim();
            localStorage.setItem('aiRewriterCustomData', customUserData);
            isCustomizeModalOpen = false;
            renderPage();
        }

        window.saveCustomTermsAndClose = function() {
            customTerms = document.getElementById('customTermsData').value.trim();
            localStorage.setItem('aiRewriterCustomTerms', customTerms);
            isTermsModalOpen = false;
            renderPage();
        }
        
        window.copyToClipboard = function(id) {
            const el = document.getElementById(id);
            if(el) { 
                el.select(); 
                document.execCommand('copy'); 
                showCustomMessage(t('alertSuccess'), t('copySuccess')); 
            }
        }

        // --- Functions for Hashtag Mode ---
        window.copyHashtagsOnly = function() {
            const el = document.getElementById('hashtagResultTextarea');
            if(el) { 
                el.select(); 
                document.execCommand('copy'); 
                showCustomMessage(t('alertSuccess'), t('copySuccess')); 
            }
        }

        window.copyContentWithHashtags = function() {
            const originalContent = document.getElementById('originalContentTextarea').value;
            const hashtags = document.getElementById('hashtagResultTextarea').value;
            
            // ‡πÉ‡∏™‡πà‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
            const combinedContent = originalContent + '\n\n' + hashtags;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á textarea ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = combinedContent;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            
            showCustomMessage(t('alertSuccess'), t('copySuccess'));
        }

        // --- Function for adding Emoji ---
        window.addEmoji = function(emoji) {
            const textarea = document.getElementById('sourceContent');
            if (textarea) {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const newText = text.substring(0, start) + emoji + text.substring(end);
                textarea.value = newText;
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                currentContent = textarea.value;
            }
        };

        window.showCustomMessage = function(title, msg) {
            const m = document.getElementById('message-modal');
            m.innerHTML = `<div class="glass-card max-w-sm p-5 text-center text-black"><h3 class="text-xl font-bold mb-2">${title}</h3><p class="mb-4">${msg}</p><button onclick="document.getElementById('message-modal').classList.add('hidden')" class="btn-primary w-full">OK</button></div>`;
            m.classList.remove('hidden');
        }

        // --- Feedback Functions ---
        window.giveFeedback = function(feedback) {
            currentFeedback = feedback;
            saveFeedback(feedback, currentContent, lastResponse, currentMode);
            renderPage();
        }

        // --- Translation Function ---
        window.translateContent = async function() {
            let contentToTranslate = '';
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            if (currentMode === 'caption' || currentMode === 'voiceover') {
                // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå: ‡πÅ‡∏õ‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£ Rewrite (After)
                contentToTranslate = lastResponse;
                if (!contentToTranslate) {
                    showCustomMessage(t('alertError'), 'No rewritten content to translate');
                    return;
                }
            } else if (currentMode === 'translation') {
                // ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤: ‡πÅ‡∏õ‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (Before)
                contentToTranslate = currentContent;
                if (!contentToTranslate) {
                    showCustomMessage(t('alertError'), t('noContent'));
                    return;
                }
            } else {
                // ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ): ‡πÉ‡∏ä‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                contentToTranslate = currentContent;
                if (!contentToTranslate) {
                    showCustomMessage(t('alertError'), t('noContent'));
                    return;
                }
            }

            isTranslating = true;
            translatedContent = t('translateLoading');
            renderPage();

            try {
                const sourceLang = detectLanguage(contentToTranslate);
                const targetLang = sourceLang === 'th' ? 'en' : 'th';
                const prompt = `Translate the following text from ${sourceLang === 'th' ? 'Thai' : 'English'} to ${targetLang === 'th' ? 'Thai' : 'English'}. Keep the original formatting, line breaks, and structure. Use special terms if available. Text: "${contentToTranslate}"`;
                
                const result = await callGeminiAPI(contentToTranslate, prompt);
                translatedContent = result.text;
                isTranslating = false;
                renderPage();
            } catch(e) {
                translatedContent = "Translation error: " + e.message;
                isTranslating = false;
                renderPage();
            }
        }

        // --- Paraphrase Function ---
        window.paraphraseContent = async function() {
            if (!lastResponse) {
                showCustomMessage(t('alertError'), 'No content to paraphrase');
                return;
            }

            const originalContent = lastResponse;
            lastResponse = "Paraphrasing...";
            renderPage();

            try {
                const prompt = `Paraphrase the following text while keeping the same meaning and language. Use different wording and sentence structures but maintain the original intent. Do not translate to another language. Text: "${originalContent}"`;
                
                const result = await callGeminiAPI(originalContent, prompt);
                lastResponse = result.text;
                renderPage();
            } catch(e) {
                lastResponse = originalContent;
                showCustomMessage(t('alertError'), "Paraphrase failed: " + e.message);
                renderPage();
            }
        }

        window.paraphraseTranslatedContent = async function() {
            let contentToParaphrase = '';
            let isTranslationMode = false;
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ paraphrase ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô
            if (currentMode === 'translation') {
                contentToParaphrase = lastResponse;
                isTranslationMode = true;
            } else {
                contentToParaphrase = translatedContent;
            }
            
            if (!contentToParaphrase) {
                showCustomMessage(t('alertError'), 'No content to paraphrase');
                return;
            }

            const originalContent = contentToParaphrase;
            
            if (isTranslationMode) {
                lastResponse = "Paraphrasing...";
            } else {
                translatedContent = "Paraphrasing...";
            }
            
            renderPage();

            try {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞ paraphrase
                const isThai = /[‡∏Å-‡πõ]/.test(originalContent);
                const targetLang = isThai ? 'Thai' : 'English';
                
                const prompt = `Paraphrase the following ${targetLang} text while keeping the same meaning and language. Use different wording and sentence structures but maintain the original intent. Do not translate to another language. Text: "${originalContent}"`;
                
                const result = await callGeminiAPI(originalContent, prompt);
                
                if (isTranslationMode) {
                    lastResponse = result.text;
                } else {
                    translatedContent = result.text;
                }
                
                renderPage();
            } catch(e) {
                if (isTranslationMode) {
                    lastResponse = originalContent;
                } else {
                    translatedContent = originalContent;
                }
                showCustomMessage(t('alertError'), "Paraphrase failed: " + e.message);
                renderPage();
            }
        }

        // --- Main Generators ---
        window.generateContent = async function(isNew, isRetry=false) {
            if(isNew) currentContent = document.getElementById('sourceContent')?.value || '';
            else if(isRetry) currentContent = document.getElementById('originalContentTextarea')?.value || currentContent;

            if(!currentContent) { showCustomMessage(t('alertTitle'), t('noContent')); return; }

            page = 'result'; 
            currentFeedback = null; // Reset feedback when generating new content
            translatedContent = ''; // Reset translation
            hashtagResult = ''; // Reset hashtag result
            isTranslating = false;
            renderPage();
            
            // Show loading in textarea
            let textarea;
            if (currentMode === 'hashtag') {
                textarea = document.getElementById('hashtagResultTextarea');
            } else if (currentMode === 'translation') {
                textarea = document.getElementById('translatedContentTextarea');
            } else {
                textarea = document.getElementById('rewrittenContentTextarea');
            }
            
            if (textarea) {
                textarea.value = t('loading');
            }
            
            try {
                let principle = "";
                let prompt = "";
                
                if(currentMode === 'caption') {
                    const sourceLang = detectLanguage(currentContent);
                    const isThai = sourceLang === 'th';
                    
                    if (isThai) {
                        principle = "Rewrite ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à ‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î.";
                        prompt = principle + ` ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${currentOptions.maxChars} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÇ‡∏î‡∏¢‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÉ‡∏™‡πà Emoji ‡πÅ‡∏•‡∏∞ 5 ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏Æ‡∏¥‡∏ï. ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏†‡∏≤‡∏û. ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö.`;
                    } else {
                        principle = "Rewrite the original English content to be engaging and attention-grabbing within 5 seconds without going off-topic. Format for easy reading with line breaks.";
                        prompt = principle + ` Write an English caption with maximum ${currentOptions.maxChars} characters, strictly based on the original content. Add Emojis and 5 trendy hashtags. Do not describe images. Do not add information unrelated to the original content.`;
                    }
                } else if (currentMode === 'voiceover') {
                    const sourceLang = detectLanguage(currentContent);
                    const isThai = sourceLang === 'th';
                    
                    if (isThai) {
                        principle = "Rewrite ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à ‡∏î‡∏∂‡∏á‡∏î‡∏π‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á. ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î.";
                        prompt = principle + ` ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Voiceover ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß ${currentOptions.lengthValue} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÇ‡∏î‡∏¢‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ${currentOptions.gender}. ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏†‡∏≤‡∏û/‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö. ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö.`;
                    } else {
                        principle = "Rewrite the original English content to be engaging and attention-grabbing within 5 seconds without going off-topic. Format for easy reading with line breaks.";
                        prompt = principle + ` Write an English Voiceover script with ${currentOptions.lengthValue} seconds duration, strictly based on the original content. ${currentOptions.gender} voice. Do not include visual/audio directions in brackets. Do not add information unrelated to the original content.`;
                    }
                } else if (currentMode === 'translation') {
                    const sourceLang = detectLanguage(currentContent);
                    const targetLang = sourceLang === 'th' ? 'en' : 'th';
                    
                    principle = `Translate the following text from ${sourceLang === 'th' ? 'Thai' : 'English'} to ${targetLang === 'th' ? 'Thai' : 'English'} accurately while maintaining the original meaning and formatting. Use only the special terms provided when exact matches are found in the original text.`;
                    prompt = principle + ` Use appropriate terminology and maintain the original tone. Do not use any user customization data, only use special terms when exact matches are found.`;
                } else if (currentMode === 'hashtag') {
                    const sourceLang = detectLanguage(currentContent);
                    const isThai = sourceLang === 'th';
                    
                    if (isThai) {
                        principle = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å) ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î";
                        prompt = principle + ` ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 10-15 ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: "${currentContent}"`;
                    } else {
                        principle = "Generate relevant and trending hashtags for the following content. Return only the hashtags, one per line (one hashtag per line), without any additional text.";
                        prompt = principle + ` Generate 10-15 English hashtags related to the content: "${currentContent}"`;
                    }
                }

                const res = await callGeminiAPI(currentContent, prompt);
                
                if (currentMode === 'hashtag') {
                    hashtagResult = res.text;
                } else {
                    lastResponse = res.text;
                }
                
                renderPage();
            } catch(e) {
                showCustomMessage(t('alertError'), e.message);
                if (currentMode === 'hashtag') {
                    hashtagResult = "Error";
                } else {
                    lastResponse = "Error";
                }
                renderPage();
            }
        }

        // Expose
        window.t = t;
        
        // Init - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        document.addEventListener('DOMContentLoaded', function() {
            const ft = localStorage.getItem('currentTheme') || 'pinkOrange';
            applyTheme(themes[ft], currentFont);
            renderPage();
        });

    </script>
</body>
</html>